name: Release

on:
  pull_request:
    types: [closed]
    branches:
      - release
      - beta

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Calculate Version
        id: versioning
        run: |
          # Extract base version from glitch using Gradle's properties task
          # This is safer than grep as it accounts for various ways the version might be defined
          BASE_VERSION=$(./gradlew :glitch:properties -q | grep "^version: " | awk '{print $2}')
          echo "Base version: $BASE_VERSION"
          
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          echo "Target branch: $TARGET_BRANCH"
          
          if [ "$TARGET_BRANCH" == "beta" ]; then
            # Find the latest beta tag for this version to increment it
            # Tags are expected to be in the format [version]-betaXX
            LATEST_BETA_TAG=$(git tag -l "$BASE_VERSION-beta*" --sort=-v:refname | head -n 1)
            
            if [ -z "$LATEST_BETA_TAG" ]; then
              NEXT_NUM="01"
              echo "No previous beta tags found. Starting with 01."
            else
              echo "Latest beta tag found: $LATEST_BETA_TAG"
              # Extract the number and increment
              LAST_NUM=$(echo "$LATEST_BETA_TAG" | sed -E "s/.*-beta([0-9]+)/\1/")
              NEXT_NUM=$(printf "%02d" $((10#$LAST_NUM + 1)))
              echo "Incremented beta number: $NEXT_NUM"
            fi
            FINAL_VERSION="$BASE_VERSION-beta$NEXT_NUM"
          else
            # For the release branch, we use the base version directly
            FINAL_VERSION="$BASE_VERSION"
          fi
          
          echo "Release version: $FINAL_VERSION"
          echo "FINAL_VERSION=$FINAL_VERSION" >> $GITHUB_ENV
          echo "version=$FINAL_VERSION" >> $GITHUB_OUTPUT

      - name: Build Library
        run: ./gradlew :glitch:assemble

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.FINAL_VERSION }}
          name: Release ${{ env.FINAL_VERSION }}
          draft: false
          prerelease: ${{ github.event.pull_request.base.ref == 'beta' }}
          generate_release_notes: true
